<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom Bingo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6b8cbc;
            --accent-color: #ff9a3c;
            --light-color: #f4f6f9;
            --dark-color: #2c3e50;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            --transition: all 0.3s ease;
        }

        /* Dark Theme Variables */
        .dark-theme {
            --primary-color: #5b8dd9;
            --secondary-color: #8cafe7;
            --light-color: #1a2430;
            --dark-color: #eaeaea;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--light-color);
            color: var(--dark-color);
            transition: var(--transition);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: var(--shadow);
            border-radius: 0 0 var(--border-radius) var(--border-radius);
        }

        h1, h2, h3 {
            margin: 0;
            font-weight: 600;
        }

        .panel {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 2rem;
            transition: var(--transition);
        }

        .panel h2 {
            margin-bottom: 1rem;
            color: var(--primary-color);
        }

        .tabs {
            display: flex;
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--primary-color);
        }

        .tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark-color);
            transition: var(--transition);
        }

        .tab.active {
            background-color: var(--primary-color);
            color: white;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }

        .tab:hover:not(.active) {
            background-color: var(--light-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        input, select, textarea, button {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(74, 111, 165, 0.2);
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 1rem;
        }

        button:hover {
            background-color: var(--secondary-color);
            box-shadow: var(--shadow);
        }

        button.secondary {
            background-color: var(--light-color);
            color: var(--dark-color);
            border: 1px solid #ddd;
        }

        button.secondary:hover {
            background-color: #e9ecef;
        }

        .action-button {
            width: auto;
            display: inline-block;
            margin-right: 0.5rem;
            margin-top: 0;
        }

        .flex-container {
            display: flex;
            gap: 1rem;
        }

        .flex-column {
            flex-direction: column;
        }

        .flex-grow {
            flex-grow: 1;
        }

        /* Word pool styling */
        .word-tag {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 50px;
            margin: 0.25rem;
            font-size: 0.9rem;
        }

        .word-lists {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 1rem;
        }

        .word-list-item {
            padding: 0.75rem;
            background-color: var(--light-color);
            border-radius: var(--border-radius);
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .word-list-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Bingo Card styling */
        .bingo-preview {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 2rem;
            margin-top: 1rem;
        }

        .bingo-card {
            width: 100%;
            max-width: 600px;
            background-color: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            page-break-inside: avoid;
            margin: 0 auto;
            position: relative;
        }

        .card-header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: center;
        }

        .card-header h3 {
            margin: 0;
            font-size: 1.5rem;
        }

        .card-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .bingo-grid {
            display: grid;
            padding: 1rem;
            gap: 0.75rem;
            aspect-ratio: 1/1;
        }

        .grid-3x3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .grid-3x4 {
            grid-template-columns: repeat(3, 1fr);
            aspect-ratio: 3/4;
        }

        .grid-4x4 {
            grid-template-columns: repeat(4, 1fr);
        }

        .grid-5x5 {
            grid-template-columns: repeat(5, 1fr);
        }

        .bingo-cell {
            aspect-ratio: 1/1;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 0.3rem;
            background-color: var(--light-color);
            border: 2px solid var(--primary-color);
            border-radius: var(--border-radius);
            font-weight: 600;
            transition: var(--transition);
            font-size: 0.9rem;
            word-break: break-word;
        }

        /* Free space styling */
        .free-space {
            background-color: var(--accent-color);
            color: white;
        }

        /* Caller panel styling */
        .called-word {
            font-size: 2rem;
            text-align: center;
            padding: 1rem;
            margin: 1rem 0;
            background-color: var(--accent-color);
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .word-history {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .history-item {
            background-color: var(--light-color);
            padding: 0.5rem 0.75rem;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
        }

        /* Player tracking styling */
        .players-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .player-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 0.5rem;
            align-items: center;
            padding: 0.75rem;
            background-color: var(--light-color);
            border-radius: var(--border-radius);
            margin-bottom: 0.5rem;
        }

        .player-name {
            font-weight: 600;
        }

        .player-score {
            text-align: center;
            font-weight: 600;
            background-color: white;
            padding: 0.25rem 0.5rem;
            border-radius: var(--border-radius);
        }

        .player-notes {
            font-size: 0.85rem;
            color: #666;
        }

        .player-actions button {
            width: 30px;
            height: 30px;
            padding: 0;
            border-radius: 50%;
            font-size: 1.2rem;
            line-height: 1;
            display: inline-flex;
            justify-content: center;
            align-items: center;
        }

        /* Themes toggle */
        .theme-toggle {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 100;
            background-color: var(--primary-color);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }

        /* Theme styling */
        .theme-selector {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .theme-option {
            width: 100px;
            height: 80px;
            border-radius: var(--border-radius);
            border: 3px solid transparent;
            cursor: pointer;
            overflow: hidden;
            transition: var(--transition);
            position: relative;
        }

        .theme-option.active {
            border-color: var(--accent-color);
            transform: scale(1.05);
        }

        .theme-option:hover:not(.active) {
            transform: scale(1.05);
        }

        .theme-name {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            text-align: center;
            padding: 0.25rem;
            font-size: 0.8rem;
        }

        .default-theme {
            background: linear-gradient(135deg, #4a6fa5, #6b8cbc);
        }

        .christmas-theme {
            background: linear-gradient(135deg, #c9184a, #1e6b35);
        }

        .halloween-theme {
            background: linear-gradient(135deg, #ff6d00, #311b92);
        }

        .spring-theme {
            background: linear-gradient(135deg, #4caf50, #8bc34a);
        }

        /* Print styles */
        @media print {
            body * {
                visibility: hidden;
            }

            .tab-content.active, .tab-content.active * {
                visibility: visible;
            }

            .tab-content.active {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }

            .no-print, .no-print * {
                display: none !important;
            }

            .container {
                width: 100%;
                max-width: 100%;
                padding: 0;
            }

            .bingo-card {
                break-inside: avoid;
                page-break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ddd;
                margin: 0.5cm;
                width: calc(50% - 1cm);
            }

            @page {
                size: A4;
                margin: 1cm;
            }
        }

        /* Download buttons styling */
        .download-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .download-actions button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .download-actions button img {
            width: 20px;
            height: 20px;
        }

        .card-actions {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 10;
        }

        .bingo-card:hover .card-actions {
            opacity: 1;
        }

        .card-actions button {
            width: 32px;
            height: 32px;
            padding: 0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .card-actions button:hover {
            transform: scale(1.1);
        }

        /* Bingo detection styling */
        .bingo-cell.marked {
            background-color: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }

        .bingo-winner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, var(--success-color), #1e7e34);
            color: white;
            padding: 1.5rem 3rem;
            border-radius: var(--border-radius);
            font-size: 2rem;
            font-weight: bold;
            z-index: 20;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3),
                        0 0 40px rgba(40, 167, 69, 0.3);
            border: 4px solid white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            letter-spacing: 2px;
            animation: winner-pulse 2s infinite;
        }

        @keyframes winner-pulse {
            0% { 
                transform: translate(-50%, -50%) scale(1);
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.3),
                            0 0 40px rgba(40, 167, 69, 0.3);
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.1);
                box-shadow: 0 0 30px rgba(0, 0, 0, 0.4),
                            0 0 60px rgba(40, 167, 69, 0.4);
            }
            100% { 
                transform: translate(-50%, -50%) scale(1);
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.3),
                            0 0 40px rgba(40, 167, 69, 0.3);
            }
        }

        /* Theme-specific winner styling */
        .dark-theme .bingo-winner {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            border-color: #34495e;
            box-shadow: 0 0 20px rgba(46, 204, 113, 0.4),
                        0 0 40px rgba(46, 204, 113, 0.2);
        }

        /* Christmas theme winner */
        body:not(.dark-theme) .christmas-theme .bingo-winner {
            background: linear-gradient(135deg, #c9184a, #a3123f);
            box-shadow: 0 0 20px rgba(201, 24, 74, 0.4),
                        0 0 40px rgba(201, 24, 74, 0.2);
        }

        /* Halloween theme winner */
        body:not(.dark-theme) .halloween-theme .bingo-winner {
            background: linear-gradient(135deg, #ff6d00, #e65100);
            box-shadow: 0 0 20px rgba(255, 109, 0, 0.4),
                        0 0 40px rgba(255, 109, 0, 0.2);
        }

        /* Spring theme winner */
        body:not(.dark-theme) .spring-theme .bingo-winner {
            background: linear-gradient(135deg, #4caf50, #388e3c);
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.4),
                        0 0 40px rgba(76, 175, 80, 0.2);
        }

        .winner-list {
            margin-top: 1rem;
            padding: 1rem;
            background-color: var(--light-color);
            border-radius: var(--border-radius);
        }

        .winner-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem;
            background-color: white;
            border-radius: var(--border-radius);
            margin-bottom: 0.5rem;
        }

        .winner-item:last-child {
            margin-bottom: 0;
        }

        .winner-name {
            font-weight: bold;
            color: var(--success-color);
        }

        .winner-pattern {
            font-size: 0.9rem;
            color: var(--dark-color);
        }
    </style>
</head>
<body>
    <header>
        <h1>Classroom Bingo</h1>
    </header>

    <div class="container">
        <div class="tabs">
            <button class="tab active" data-tab="setup">Setup</button>
            <button class="tab" data-tab="cards">Bingo Cards</button>
            <button class="tab" data-tab="caller">Caller Panel</button>
            <button class="tab" data-tab="players">Player Tracking</button>
            <button class="tab" data-tab="settings">Settings</button>
        </div>
        <div style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
            <a href="/" style="display: flex; align-items: center; justify-content: center; width: 50px; height: 50px; background-color: #3498db; color: white; border-radius: 50%; box-shadow: 0 4px 8px rgba(0,0,0,0.3); text-decoration: none; transition: transform 0.3s ease, box-shadow 0.3s ease;" title="Back to Dashboard">
                <i class="fas fa-home" style="font-size: 20px;"></i>
            </a>
        </div>

        <!-- Setup Tab -->
        <div class="tab-content active" id="setup">
            <div class="flex-container">
                <!-- Word Pool Panel -->
                <div class="panel flex-grow">
                    <h2>Word Pool</h2>
                    <div class="form-group">
                        <label for="wordList">Enter Words (one per line)</label>
                        <textarea id="wordList" rows="8" placeholder="Enter words for the bingo cards..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="wordListName">List Name</label>
                        <input type="text" id="wordListName" placeholder="e.g., Vocabulary - Weather">
                    </div>
                    <button id="saveWordList">Save Word List</button>

                    <div class="word-lists">
                        <h3>Saved Word Lists</h3>
                        <div id="savedWordLists"></div>
                    </div>
                </div>

                <!-- Students Panel -->
                <div class="panel flex-grow">
                    <h2>Students</h2>
                    <div class="form-group">
                        <label for="studentList">Enter Student Names (one per line)</label>
                        <textarea id="studentList" rows="8" placeholder="Enter student names..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="className">Class Name</label>
                        <input type="text" id="className" placeholder="e.g., 3rd Grade - Mrs. Smith">
                    </div>
                    <button id="saveStudentList">Save Student List</button>

                    <div class="word-lists">
                        <h3>Saved Classes</h3>
                        <div id="savedClasses"></div>
                    </div>
                </div>
            </div>

            <!-- Card Settings Panel -->
            <div class="panel">
                <h2>Bingo Card Settings</h2>
                <div class="flex-container">
                    <div class="form-group flex-grow">
                        <label for="gridSize">Grid Size</label>
                        <select id="gridSize">
                            <option value="3x3">3Ã—3 Grid</option>
                            <option value="3x4">3Ã—4 Grid</option>
                            <option value="4x4">4Ã—4 Grid</option>
                            <option value="5x5" selected>5Ã—5 Grid</option>
                        </select>
                    </div>
                    <div class="form-group flex-grow">
                        <label for="activeWordList">Word List to Use</label>
                        <select id="activeWordList">
                            <option value="" disabled selected>Select a word list</option>
                        </select>
                    </div>
                    <div class="form-group flex-grow">
                        <label for="activeClass">Class to Generate For</label>
                        <select id="activeClass">
                            <option value="" disabled selected>Select a class</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="freeSpace">Free Space (leave empty for no free space)</label>
                    <input type="text" id="freeSpace" placeholder="e.g., FREE" value="FREE">
                </div>
                <button id="generateCards">Generate Bingo Cards</button>
            </div>
        </div>

        <!-- Cards Tab -->
        <div class="tab-content" id="cards">
            <div class="panel">
                <h2>Bingo Cards</h2>
                <div class="download-actions no-print">
                    <button id="downloadAllCards">
                        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxwYXRoIGQ9Ik0yMSAxNWv0IDZ2LTZhMiAyIDAgMCAwLTIgMkg1YTIgMiAwIDAgMC0yIDJ2NmEyIDIgMCAwIDAgMiAyaDE0YTIgMiAwIDAgMCAyLTJ6Ij48L3BhdGg+PHBvbHlsaW5lIHBvaW50cz0iNyAxMCAxMiAxNSAxNyAxMCI+PC9wb2x5bGluZT48bGluZSB4MT0iMTIiIHkxPSIxNSIgeDI9IjEyIiB5Mj0iMyI+PC9saW5lPjwvc3ZnPg==" alt="Download">
                        Download All Cards
                    </button>
                    <button id="printCards">Print All Cards</button>
                </div>
                <div id="bingoCardsContainer" class="bingo-preview"></div>
            </div>
        </div>

        <!-- Caller Tab -->
        <div class="tab-content" id="caller">
            <div class="panel">
                <h2>Word Caller</h2>
                <div class="called-word" id="currentWord">Click "Call Next Word" to start</div>
                <div class="flex-container no-print">
                    <button id="callWord" class="flex-grow">Call Next Word</button>
                    <button id="resetCaller" class="secondary flex-grow">Reset Game</button>
                </div>
                <h3>Called Words History</h3>
                <div class="word-history" id="calledWords"></div>
                <div class="winner-list" id="winnerList">
                    <h3>Bingo Winners</h3>
                    <div id="winnersContainer"></div>
                </div>
            </div>
        </div>

        <!-- Player Tracking Tab -->
        <div class="tab-content" id="players">
            <div class="panel">
                <h2>Player Tracking</h2>
                <div class="flex-container no-print">
                    <div class="form-group flex-grow">
                        <label for="playerClass">Select Class</label>
                        <select id="playerClass">
                            <option value="" disabled selected>Select a class</option>
                        </select>
                    </div>
                    <div class="form-group flex-grow">
                        <label for="scoreValue">Points to Add/Subtract</label>
                        <input type="number" id="scoreValue" value="1" min="1">
                    </div>
                </div>
                <div class="players-list" id="playersListContainer"></div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div class="tab-content" id="settings">
            <div class="panel">
                <h2>Theme Settings</h2>
                <div class="theme-selector">
                    <div class="theme-option default-theme active" data-theme="default">
                        <div class="theme-name">Default</div>
                    </div>
                    <div class="theme-option christmas-theme" data-theme="christmas">
                        <div class="theme-name">Christmas</div>
                    </div>
                    <div class="theme-option halloween-theme" data-theme="halloween">
                        <div class="theme-name">Halloween</div>
                    </div>
                    <div class="theme-option spring-theme" data-theme="spring">
                        <div class="theme-name">Spring</div>
                    </div>
                </div>
            </div>
            <div class="panel">
                <h2>Import/Export Data</h2>
                <div class="flex-container">
                    <button id="exportData" class="flex-grow">Export All Data</button>
                    <div class="form-group flex-grow">
                        <label for="importData">Import Data</label>
                        <input type="file" id="importData" accept=".json">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Theme toggle button -->
    <button class="theme-toggle" id="darkModeToggle">ðŸŒ™</button>

    <script>
        // Data structure
        let state = {
            wordLists: [],
            classes: [],
            currentGame: {
                activeWordList: null,
                activeClass: null,
                gridSize: '5x5',
                freeSpace: 'FREE',
                cards: [],
                calledWords: [],
                scores: {},
                winners: [],
                notes: {}
            },
            theme: 'default',
            darkMode: false
        };

        // DOM Elements
        const elements = {
            tabs: document.querySelectorAll('.tab'),
            tabContents: document.querySelectorAll('.tab-content'),
            wordList: document.getElementById('wordList'),
            wordListName: document.getElementById('wordListName'),
            saveWordList: document.getElementById('saveWordList'),
            savedWordLists: document.getElementById('savedWordLists'),
            studentList: document.getElementById('studentList'),
            className: document.getElementById('className'),
            saveStudentList: document.getElementById('saveStudentList'),
            savedClasses: document.getElementById('savedClasses'),
            gridSize: document.getElementById('gridSize'),
            activeWordList: document.getElementById('activeWordList'),
            activeClass: document.getElementById('activeClass'),
            freeSpace: document.getElementById('freeSpace'),
            generateCards: document.getElementById('generateCards'),
            bingoCardsContainer: document.getElementById('bingoCardsContainer'),
            printCards: document.getElementById('printCards'),
            currentWord: document.getElementById('currentWord'),
            callWord: document.getElementById('callWord'),
            resetCaller: document.getElementById('resetCaller'),
            calledWords: document.getElementById('calledWords'),
            playerClass: document.getElementById('playerClass'),
            playersListContainer: document.getElementById('playersListContainer'),
            scoreValue: document.getElementById('scoreValue'),
            themeOptions: document.querySelectorAll('.theme-option'),
            darkModeToggle: document.getElementById('darkModeToggle'),
            exportData: document.getElementById('exportData'),
            importData: document.getElementById('importData')
        };

        // Initialize the application
        function init() {
            // Load data from localStorage
            loadFromLocalStorage();
            
            // Set up event listeners
            setupEventListeners();
            
            // Render initial UI state
            renderWordLists();
            renderClasses();
            updateDropdowns();
        }

        // Set up event listeners
        function setupEventListeners() {
            // Tab navigation
            elements.tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });

            // Word list management
            elements.saveWordList.addEventListener('click', saveWordList);
            
            // Student list management
            elements.saveStudentList.addEventListener('click', saveStudentList);
            
            // Card generation
            elements.generateCards.addEventListener('click', generateCards);
            elements.printCards.addEventListener('click', printCards);
            
            // Caller panel
            elements.callWord.addEventListener('click', callNextWord);
            elements.resetCaller.addEventListener('click', resetCaller);
            
            // Theme settings
            elements.themeOptions.forEach(option => {
                option.addEventListener('click', () => {
                    const theme = option.getAttribute('data-theme');
                    setTheme(theme);
                });
            });
            
            elements.darkModeToggle.addEventListener('click', toggleDarkMode);
            
            // Import/Export
            elements.exportData.addEventListener('click', exportAllData);
            elements.importData.addEventListener('change', importAllData);
            
            // Grid size change updates free space visibility
            elements.gridSize.addEventListener('change', updateFreeSpaceField);

            // Download buttons
            document.getElementById('downloadAllCards').addEventListener('click', downloadAllCards);
        }

        // Switch between tabs
        function switchTab(tabId) {
            // Update active tab button
            elements.tabs.forEach(tab => {
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            // Update active tab content
            elements.tabContents.forEach(content => {
                if (content.id === tabId) {
                    content.classList.add('active');
                    
                    // Special actions for specific tabs
                    if (tabId === 'players') {
                        renderPlayersList();
                    }
                } else {
                    content.classList.remove('active');
                }
            });
        }

        // Word list management
        function saveWordList() {
            const name = elements.wordListName.value.trim();
            const wordsText = elements.wordList.value.trim();
            
            if (!name) {
                alert('Please enter a name for the word list');
                return;
            }
            
            if (!wordsText) {
                alert('Please enter some words for the list');
                return;
            }
            
            const words = wordsText.split('\n')
                .map(word => word.trim())
                .filter(word => word.length > 0);
                
            if (words.length < 9) {
                alert('Please enter at least 9 words for a 3x3 grid');
                return;
            }
            
            // Check if a list with this name already exists
            const existingIndex = state.wordLists.findIndex(list => list.name === name);
            
            if (existingIndex >= 0) {
                // Update existing list
                state.wordLists[existingIndex].words = words;
            } else {
                // Create new list
                state.wordLists.push({
                    id: Date.now().toString(),
                    name,
                    words
                });
            }
            
            // Save to localStorage and update UI
            saveToLocalStorage();
            renderWordLists();
            updateDropdowns();
            
            // Clear form
            elements.wordListName.value = '';
            elements.wordList.value = '';
            
            alert(`Word list "${name}" saved successfully!`);
        }

        // Render word lists in the UI
        function renderWordLists() {
            const container = elements.savedWordLists;
            container.innerHTML = '';
            
            if (state.wordLists.length === 0) {
                container.innerHTML = '<p>No word lists saved yet.</p>';
                return;
            }
            
            state.wordLists.forEach(list => {
                const listItem = document.createElement('div');
                listItem.className = 'word-list-item';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = `${list.name} (${list.words.length} words)`;
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'word-list-actions';
                
                const editButton = document.createElement('button');
                editButton.className = 'action-button';
                editButton.textContent = 'Edit';
                editButton.addEventListener('click', () => editWordList(list.id));
                
                const deleteButton = document.createElement('button');
                deleteButton.className = 'action-button secondary';
                deleteButton.textContent = 'Delete';
                deleteButton.addEventListener('click', () => deleteWordList(list.id));
                
                actionsDiv.appendChild(editButton);
                actionsDiv.appendChild(deleteButton);
                
                listItem.appendChild(nameSpan);
                listItem.appendChild(actionsDiv);
                
                container.appendChild(listItem);
            });
        }

        // Edit a word list
        function editWordList(id) {
            const list = state.wordLists.find(list => list.id === id);
            
            if (list) {
                elements.wordListName.value = list.name;
                elements.wordList.value = list.words.join('\n');
                
                // Scroll to the form
                elements.wordListName.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Delete a word list
        function deleteWordList(id) {
            if (confirm('Are you sure you want to delete this word list?')) {
                state.wordLists = state.wordLists.filter(list => list.id !== id);
                
                // Update active word list if needed
                if (state.currentGame.activeWordList === id) {
                    state.currentGame.activeWordList = null;
                }
                
                // Save to localStorage and update UI
                saveToLocalStorage();
                renderWordLists();
                updateDropdowns();
            }
        }

        // Student list management
        function saveStudentList() {
            const name = elements.className.value.trim();
            const studentsText = elements.studentList.value.trim();
            
            if (!name) {
                alert('Please enter a name for the class');
                return;
            }
            
            if (!studentsText) {
                alert('Please enter student names');
                return;
            }
            
            const students = studentsText.split('\n')
                .map(student => student.trim())
                .filter(student => student.length > 0);
                
            if (students.length === 0) {
                alert('Please enter at least one student name');
                return;
            }
            
            // Check if a class with this name already exists
            const existingIndex = state.classes.findIndex(cls => cls.name === name);
            
            if (existingIndex >= 0) {
                // Update existing class
                state.classes[existingIndex].students = students;
            } else {
                // Create new class
                state.classes.push({
                    id: Date.now().toString(),
                    name,
                    students
                });
            }
            
            // Initialize scores for new students
            students.forEach(student => {
                if (!state.currentGame.scores[student]) {
                    state.currentGame.scores[student] = 0;
                }
            });
            
            // Save to localStorage and update UI
            saveToLocalStorage();
            renderClasses();
            updateDropdowns();
            
            // Clear form
            elements.className.value = '';
            elements.studentList.value = '';
            
            alert(`Class "${name}" saved successfully!`);
        }

        // Render classes in the UI
        function renderClasses() {
            const container = elements.savedClasses;
            container.innerHTML = '';
            
            if (state.classes.length === 0) {
                container.innerHTML = '<p>No classes saved yet.</p>';
                return;
            }
            
            state.classes.forEach(cls => {
                const listItem = document.createElement('div');
                listItem.className = 'word-list-item';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = `${cls.name} (${cls.students.length} students)`;
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'word-list-actions';
                
                const editButton = document.createElement('button');
                editButton.className = 'action-button';
                editButton.textContent = 'Edit';
                editButton.addEventListener('click', () => editClass(cls.id));
                
                const deleteButton = document.createElement('button');
                deleteButton.className = 'action-button secondary';
                deleteButton.textContent = 'Delete';
                deleteButton.addEventListener('click', () => deleteClass(cls.id));
                
                actionsDiv.appendChild(editButton);
                actionsDiv.appendChild(deleteButton);
                
                listItem.appendChild(nameSpan);
                listItem.appendChild(actionsDiv);
                
                container.appendChild(listItem);
            });
        }

        // Edit a class
        function editClass(id) {
            const cls = state.classes.find(cls => cls.id === id);
            
            if (cls) {
                elements.className.value = cls.name;
                elements.studentList.value = cls.students.join('\n');
                
                // Scroll to the form
                elements.className.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Delete a class
        function deleteClass(id) {
            if (confirm('Are you sure you want to delete this class?')) {
                state.classes = state.classes.filter(cls => cls.id !== id);
                
                // Update active class if needed
                if (state.currentGame.activeClass === id) {
                    state.currentGame.activeClass = null;
                }
                
                // Save to localStorage and update UI
                saveToLocalStorage();
                renderClasses();
                updateDropdowns();
            }
        }

        // Update dropdowns with current word lists and classes
        function updateDropdowns() {
            // Update word list dropdown
            const wordListSelect = elements.activeWordList;
            wordListSelect.innerHTML = '<option value="" disabled selected>Select a word list</option>';
            
            state.wordLists.forEach(list => {
                const option = document.createElement('option');
                option.value = list.id;
                option.textContent = list.name;
                wordListSelect.appendChild(option);
            });
            
            // Update class dropdowns (for card generation and player tracking)
            const classSelects = [elements.activeClass, elements.playerClass];
            
            classSelects.forEach(select => {
                if (select) {
                    select.innerHTML = '<option value="" disabled selected>Select a class</option>';
                    
                    state.classes.forEach(cls => {
                        const option = document.createElement('option');
                        option.value = cls.id;
                        option.textContent = cls.name;
                        select.appendChild(option);
                    });
                }
            });
            
            // Set values if active selections exist
            if (state.currentGame.activeWordList) {
                elements.activeWordList.value = state.currentGame.activeWordList;
            }
            
            if (state.currentGame.activeClass) {
                elements.activeClass.value = state.currentGame.activeClass;
                elements.playerClass.value = state.currentGame.activeClass;
            }
            
            // Update grid size and free space
            elements.gridSize.value = state.currentGame.gridSize;
            elements.freeSpace.value = state.currentGame.freeSpace;
            
            updateFreeSpaceField();
        }

        // Update free space field based on grid size
        function updateFreeSpaceField() {
            const gridSize = elements.gridSize.value;
            const freeSpaceField = elements.freeSpace;
            
            // Only 5x5 grids traditionally have a free space
            if (gridSize === '5x5') {
                freeSpaceField.disabled = false;
                freeSpaceField.placeholder = 'e.g., FREE';
            } else {
                freeSpaceField.disabled = true;
                freeSpaceField.placeholder = 'Free space available only for 5Ã—5 grids';
            }
        }

        // Generate bingo cards
        function generateCards() {
            const wordListId = elements.activeWordList.value;
            const classId = elements.activeClass.value;
            const gridSize = elements.gridSize.value;
            const freeSpace = elements.freeSpace.value.trim();
            
            if (!wordListId) {
                alert('Please select a word list');
                return;
            }
            
            if (!classId) {
                alert('Please select a class');
                return;
            }
            
            // Get word list and class
            const wordList = state.wordLists.find(list => list.id === wordListId);
            const cls = state.classes.find(c => c.id === classId);
            
            if (!wordList || !cls) {
                alert('Error: Word list or class not found');
                return;
            }
            
            // Check if we have enough words for the grid size
            const [rows, cols] = gridSize.split('x').map(Number);
            const cellCount = rows * cols;
            let minWords = cellCount;
            
            // If using a free space in 5x5, we need one less word
            if (gridSize === '5x5' && freeSpace) {
                minWords = cellCount - 1;
            }
            
            if (wordList.words.length < minWords) {
                alert(`Not enough words for ${gridSize} grid. Need at least ${minWords} words.`);
                return;
            }
            
            // Generate cards
            const cards = cls.students.map(student => {
                return generateBingoCard(student, wordList.words, gridSize, freeSpace);
            });
            
            // Save current game state
            state.currentGame = {
                ...state.currentGame,
                activeWordList: wordListId,
                activeClass: classId,
                gridSize: gridSize,
                freeSpace: freeSpace,
                cards: cards,
                calledWords: [],
                winners: [],
                scores: state.currentGame.scores || {},
                notes: state.currentGame.notes || {}
            };
            
            // Save to localStorage
            saveToLocalStorage();
            
            // Display cards
            renderBingoCards();
            
            // Switch to cards tab
            switchTab('cards');
        }

        // Generate a single bingo card
        function generateBingoCard(studentName, allWords, gridSize, freeSpace) {
            // Parse grid dimensions
            const [rows, cols] = gridSize.split('x').map(Number);
            
            // Shuffle and select words
            const shuffledWords = shuffleArray([...allWords]);
            let cellCount = rows * cols;
            
            // If using a free space in 5x5, we need one less word
            const hasFreeSpace = gridSize === '5x5' && freeSpace;
            if (hasFreeSpace) {
                cellCount--;
            }
            
            const selectedWords = shuffledWords.slice(0, cellCount);
            
            // Create grid
            const grid = [];
            let wordIndex = 0;
            
            for (let i = 0; i < rows; i++) {
                const row = [];
                for (let j = 0; j < cols; j++) {
                    // For 5x5 grid with free space, place it in the center
                    if (hasFreeSpace && i === 2 && j === 2) {
                        row.push({ text: freeSpace, isFree: true });
                    } else {
                        row.push({ text: selectedWords[wordIndex++], isFree: false });
                    }
                }
                grid.push(row);
            }
            
            return {
                studentName,
                grid,
                gridSize
            };
        }

        // Render all bingo cards
        function renderBingoCards() {
            const container = elements.bingoCardsContainer;
            container.innerHTML = '';
            
            if (!state.currentGame.cards || state.currentGame.cards.length === 0) {
                container.innerHTML = '<p>No cards generated yet. Go to Setup tab to generate cards.</p>';
                return;
            }
            
            state.currentGame.cards.forEach(card => {
                const cardElement = createCardElement(card);
                container.appendChild(cardElement);
            });
        }

        // Create a single card element
        function createCardElement(card) {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'bingo-card';
            
            // Add winner overlay if applicable
            if (state.currentGame.winners && state.currentGame.winners.length > 0) {
                const winner = state.currentGame.winners.find(w => w.studentName === card.studentName);
                if (winner) {
                    const winnerOverlay = document.createElement('div');
                    winnerOverlay.className = 'bingo-winner';
                    winnerOverlay.textContent = 'BINGO!';
                    cardDiv.appendChild(winnerOverlay);
                }
            }
            
            const headerDiv = document.createElement('div');
            headerDiv.className = 'card-header';
            
            const titleH3 = document.createElement('h3');
            titleH3.textContent = 'BINGO';
            
            const studentNameDiv = document.createElement('div');
            studentNameDiv.className = 'card-title';
            studentNameDiv.textContent = card.studentName;
            
            headerDiv.appendChild(titleH3);
            headerDiv.appendChild(studentNameDiv);
            
            const gridDiv = document.createElement('div');
            gridDiv.className = `bingo-grid grid-${card.gridSize}`;
            
            // Create cells
            card.grid.forEach(row => {
                row.forEach(cell => {
                    const cellDiv = document.createElement('div');
                    cellDiv.className = 'bingo-cell';
                    
                    if (cell.isFree) {
                        cellDiv.classList.add('free-space');
                    }
                    
                    // Mark cell if word has been called
                    if (state.currentGame.calledWords && state.currentGame.calledWords.length > 0 &&
                        (cell.text === state.currentGame.calledWords[state.currentGame.calledWords.length - 1] ||
                         state.currentGame.calledWords.includes(cell.text))) {
                        cellDiv.classList.add('marked');
                    }
                    
                    cellDiv.textContent = cell.text;
                    gridDiv.appendChild(cellDiv);
                });
            });
            
            // Add download button
            const cardActions = document.createElement('div');
            cardActions.className = 'card-actions no-print';
            
            const downloadButton = document.createElement('button');
            downloadButton.title = 'Download Card';
            downloadButton.innerHTML = 'â¬‡ï¸';
            downloadButton.addEventListener('click', () => downloadCard(cardDiv, card.studentName));
            
            cardActions.appendChild(downloadButton);
            
            cardDiv.appendChild(headerDiv);
            cardDiv.appendChild(gridDiv);
            cardDiv.appendChild(cardActions);
            
            return cardDiv;
        }

        // Download a single card as PNG
        async function downloadCard(cardElement, studentName) {
            try {
                // Create a temporary container
                const tempContainer = document.createElement('div');
                tempContainer.style.position = 'fixed';
                tempContainer.style.top = '0';
                tempContainer.style.left = '0';
                tempContainer.style.width = '100%';
                tempContainer.style.height = '100%';
                tempContainer.style.backgroundColor = 'white';
                tempContainer.style.zIndex = '-9999';
                document.body.appendChild(tempContainer);
                
                // Create a clean clone without download buttons
                const clone = cardElement.cloneNode(true);
                const downloadButton = clone.querySelector('.card-actions');
                if (downloadButton) {
                    downloadButton.remove();
                }
                
                // Add clone to temporary container
                tempContainer.appendChild(clone);
                
                // Wait for a frame to ensure rendering
                await new Promise(resolve => requestAnimationFrame(resolve));
                
                // Convert card to image
                const data = await html2canvas(clone, {
                    scale: 2,
                    backgroundColor: '#ffffff',
                    logging: true,
                    useCORS: true,
                    allowTaint: true,
                    width: clone.offsetWidth,
                    height: clone.offsetHeight,
                    windowWidth: clone.offsetWidth,
                    windowHeight: clone.offsetHeight
                });
                
                // Download the image
                const link = document.createElement('a');
                link.download = `bingo-card-${studentName}.png`;
                link.href = data.toDataURL('image/png');
                link.click();
                
                // Clean up
                document.body.removeChild(tempContainer);
            } catch (error) {
                console.error('Error downloading card:', error);
                alert('Error downloading card. Please try again.');
            }
        }

        // Download all cards as ZIP
        async function downloadAllCards() {
            const downloadButton = document.getElementById('downloadAllCards');
            const originalContent = downloadButton.innerHTML;
            
            try {
                downloadButton.innerHTML = 'â³ Processing...';
                downloadButton.disabled = true;
                
                const zip = new JSZip();
                const cards = document.querySelectorAll('.bingo-card');
                
                // Create a temporary container
                const tempContainer = document.createElement('div');
                tempContainer.style.position = 'fixed';
                tempContainer.style.top = '0';
                tempContainer.style.left = '0';
                tempContainer.style.width = '100%';
                tempContainer.style.height = '100%';
                tempContainer.style.backgroundColor = 'white';
                tempContainer.style.zIndex = '-9999';
                document.body.appendChild(tempContainer);
                
                // Process each card
                for (let i = 0; i < cards.length; i++) {
                    const card = cards[i];
                    const studentName = card.querySelector('.card-title').textContent;
                    
                    // Create a clean clone without download buttons
                    const clone = card.cloneNode(true);
                    const downloadButton = clone.querySelector('.card-actions');
                    if (downloadButton) {
                        downloadButton.remove();
                    }
                    
                    // Add clone to temporary container
                    tempContainer.appendChild(clone);
                    
                    // Wait for a frame to ensure rendering
                    await new Promise(resolve => requestAnimationFrame(resolve));
                    
                    // Convert to canvas
                    const canvas = await html2canvas(clone, {
                        scale: 2,
                        backgroundColor: '#ffffff',
                        logging: true,
                        useCORS: true,
                        allowTaint: true,
                        width: clone.offsetWidth,
                        height: clone.offsetHeight,
                        windowWidth: clone.offsetWidth,
                        windowHeight: clone.offsetHeight
                    });
                    
                    // Remove the clone after capturing
                    tempContainer.removeChild(clone);
                    
                    // Add to zip
                    const imageData = canvas.toDataURL('image/png').split(',')[1];
                    zip.file(`bingo-card-${studentName}.png`, imageData, {base64: true});
                }
                
                // Clean up temporary container
                document.body.removeChild(tempContainer);
                
                // Generate and download zip
                const content = await zip.generateAsync({type: 'blob'});
                const link = document.createElement('a');
                link.download = 'bingo-cards.zip';
                link.href = URL.createObjectURL(content);
                link.click();
                
            } catch (error) {
                console.error('Error creating zip:', error);
                alert('Error creating zip file. Please try again.');
            } finally {
                // Reset button state
                downloadButton.innerHTML = originalContent;
                downloadButton.disabled = false;
            }
        }

        // Print cards
        function printCards() {
            window.print();
        }

        // Caller panel functions
        function callNextWord() {
            // Get word list
            const wordListId = state.currentGame.activeWordList;
            if (!wordListId) {
                alert('No active word list. Please generate cards first.');
                return;
            }
            
            const wordList = state.wordLists.find(list => list.id === wordListId);
            if (!wordList) {
                alert('Word list not found');
                return;
            }
            
            // Find words that haven't been called yet
            const availableWords = wordList.words.filter(word => 
                !state.currentGame.calledWords.includes(word));
            
            if (availableWords.length === 0) {
                alert('All words have been called! Reset the game to start over.');
                return;
            }
            
            // Randomly select a word
            const randomIndex = Math.floor(Math.random() * availableWords.length);
            const calledWord = availableWords[randomIndex];
            
            // Add to called words
            state.currentGame.calledWords.push(calledWord);
            
            // Check for bingos
            checkForBingos(calledWord);
            
            // Save to localStorage
            saveToLocalStorage();
            
            // Update UI
            elements.currentWord.textContent = calledWord;
            renderCalledWords();
            renderBingoCards();
            renderWinners();
        }

        // Reset caller
        function resetCaller() {
            if (confirm('Are you sure you want to reset the game? This will clear all called words and winners.')) {
                state.currentGame.calledWords = [];
                state.currentGame.winners = [];
                
                // Save to localStorage
                saveToLocalStorage();
                
                // Update UI
                elements.currentWord.textContent = 'Click "Call Next Word" to start';
                renderCalledWords();
                renderBingoCards();
                renderWinners();
            }
        }

        // Check for bingos
        function checkForBingos(calledWord) {
            if (!state.currentGame.cards) return;
            
            state.currentGame.cards.forEach(card => {
                // Skip if already a winner
                if (state.currentGame.winners.some(w => w.studentName === card.studentName)) {
                    return;
                }
                
                // Check each cell for the called word
                let hasBingo = false;
                let winningPattern = '';
                
                // Check rows
                for (let i = 0; i < card.grid.length; i++) {
                    if (checkRow(card.grid[i], calledWord)) {
                        hasBingo = true;
                        winningPattern = `Row ${i + 1}`;
                        break;
                    }
                }
                
                // Check columns
                if (!hasBingo) {
                    for (let j = 0; j < card.grid[0].length; j++) {
                        if (checkColumn(card.grid, j, calledWord)) {
                            hasBingo = true;
                            winningPattern = `Column ${j + 1}`;
                            break;
                        }
                    }
                }
                
                // Check diagonals
                if (!hasBingo) {
                    if (checkDiagonal(card.grid, calledWord, true)) {
                        hasBingo = true;
                        winningPattern = 'Diagonal (top-left to bottom-right)';
                    } else if (checkDiagonal(card.grid, calledWord, false)) {
                        hasBingo = true;
                        winningPattern = 'Diagonal (top-right to bottom-left)';
                    }
                }
                
                // If bingo found, add to winners
                if (hasBingo) {
                    state.currentGame.winners.push({
                        studentName: card.studentName,
                        pattern: winningPattern,
                        timestamp: new Date().toISOString()
                    });
                }
            });
        }

        // Check if a row has bingo
        function checkRow(row, calledWord) {
            return row.every(cell => 
                cell.text === calledWord || 
                cell.isFree || 
                state.currentGame.calledWords.includes(cell.text)
            );
        }

        // Check if a column has bingo
        function checkColumn(grid, colIndex, calledWord) {
            return grid.every(row => {
                const cell = row[colIndex];
                return cell.text === calledWord || 
                       cell.isFree || 
                       state.currentGame.calledWords.includes(cell.text);
            });
        }

        // Check if a diagonal has bingo
        function checkDiagonal(grid, calledWord, isMainDiagonal) {
            const size = grid.length;
            return Array.from({length: size}, (_, i) => {
                const cell = isMainDiagonal ? grid[i][i] : grid[i][size - 1 - i];
                return cell.text === calledWord || 
                       cell.isFree || 
                       state.currentGame.calledWords.includes(cell.text);
            }).every(Boolean);
        }

        // Render called words
        function renderCalledWords() {
            const container = elements.calledWords;
            container.innerHTML = '';
            
            if (state.currentGame.calledWords.length === 0) {
                container.innerHTML = '<p>No words called yet.</p>';
                return;
            }
            
            // Display in reverse order (newest first)
            [...state.currentGame.calledWords].reverse().forEach(word => {
                const wordSpan = document.createElement('span');
                wordSpan.className = 'history-item';
                wordSpan.textContent = word;
                container.appendChild(wordSpan);
            });
        }

        // Render winners
        function renderWinners() {
            const container = document.getElementById('winnersContainer');
            container.innerHTML = '';
            
            if (state.currentGame.winners.length === 0) {
                container.innerHTML = '<p>No winners yet.</p>';
                return;
            }
            
            state.currentGame.winners.forEach(winner => {
                const winnerDiv = document.createElement('div');
                winnerDiv.className = 'winner-item';
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'winner-name';
                nameSpan.textContent = winner.studentName;
                
                const patternSpan = document.createElement('span');
                patternSpan.className = 'winner-pattern';
                patternSpan.textContent = `(${winner.pattern})`;
                
                winnerDiv.appendChild(nameSpan);
                winnerDiv.appendChild(patternSpan);
                container.appendChild(winnerDiv);
            });
        }

        // Player tracking functions
        function renderPlayersList() {
            const container = elements.playersListContainer;
            container.innerHTML = '';
            
            const classId = elements.playerClass.value;
            if (!classId) {
                container.innerHTML = '<p>Please select a class above.</p>';
                return;
            }
            
            const cls = state.classes.find(c => c.id === classId);
            if (!cls) {
                container.innerHTML = '<p>Class not found.</p>';
                return;
            }
            
            // Create header row
            const headerDiv = document.createElement('div');
            headerDiv.className = 'player-item';
            headerDiv.style.fontWeight = 'bold';
            
            const nameHeader = document.createElement('div');
            nameHeader.textContent = 'Student Name';
            
            const scoreHeader = document.createElement('div');
            scoreHeader.textContent = 'Score';
            
            const notesHeader = document.createElement('div');
            notesHeader.textContent = 'Notes';
            
            const actionsHeader = document.createElement('div');
            actionsHeader.textContent = 'Actions';
            
            headerDiv.appendChild(nameHeader);
            headerDiv.appendChild(scoreHeader);
            headerDiv.appendChild(notesHeader);
            headerDiv.appendChild(actionsHeader);
            
            container.appendChild(headerDiv);
            
            // Create player rows
            cls.students.forEach(student => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-item';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'player-name';
                nameDiv.textContent = student;
                
                const scoreDiv = document.createElement('div');
                scoreDiv.className = 'player-score';
                scoreDiv.textContent = state.currentGame.scores[student] || 0;
                
                const notesDiv = document.createElement('div');
                notesDiv.className = 'player-notes';
                
                const notesInput = document.createElement('input');
                notesInput.type = 'text';
                notesInput.placeholder = 'Add notes';
                notesInput.dataset.student = student;
                notesInput.value = state.currentGame.notes ? (state.currentGame.notes[student] || '') : '';
                notesInput.addEventListener('change', updatePlayerNotes);
                
                notesDiv.appendChild(notesInput);
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'player-actions';
                
                const addButton = document.createElement('button');
                addButton.textContent = '+';
                addButton.title = 'Add points';
                addButton.addEventListener('click', () => updatePlayerScore(student, true));
                
                const subButton = document.createElement('button');
                subButton.textContent = '-';
                subButton.title = 'Subtract points';
                subButton.addEventListener('click', () => updatePlayerScore(student, false));
                
                actionsDiv.appendChild(addButton);
                actionsDiv.appendChild(subButton);
                
                playerDiv.appendChild(nameDiv);
                playerDiv.appendChild(scoreDiv);
                playerDiv.appendChild(notesDiv);
                playerDiv.appendChild(actionsDiv);
                
                container.appendChild(playerDiv);
            });
        }

        // Update player score
        function updatePlayerScore(student, isAdd) {
            const scoreValue = parseInt(elements.scoreValue.value) || 1;
            
            // Initialize score if not exist
            if (!state.currentGame.scores[student]) {
                state.currentGame.scores[student] = 0;
            }
            
            // Update score
            if (isAdd) {
                state.currentGame.scores[student] += scoreValue;
            } else {
                state.currentGame.scores[student] = Math.max(0, state.currentGame.scores[student] - scoreValue);
            }
            
            // Save to localStorage
            saveToLocalStorage();
            
            // Update UI
            renderPlayersList();
        }

        // Update player notes
        function updatePlayerNotes(event) {
            const student = event.target.dataset.student;
            const notes = event.target.value;
            
            // Initialize notes object if not exist
            if (!state.currentGame.notes) {
                state.currentGame.notes = {};
            }
            
            // Update notes
            state.currentGame.notes[student] = notes;
            
            // Save to localStorage
            saveToLocalStorage();
        }

        // Theme functions
        function setTheme(theme) {
            // Remove active class from all options
            elements.themeOptions.forEach(option => {
                option.classList.remove('active');
            });
            
            // Add active class to selected option
            const selectedOption = document.querySelector(`.theme-option[data-theme="${theme}"]`);
            if (selectedOption) {
                selectedOption.classList.add('active');
            }
            
            // Update theme variables
            const root = document.documentElement;
            
            switch (theme) {
                case 'christmas':
                    root.style.setProperty('--primary-color', '#c9184a');
                    root.style.setProperty('--secondary-color', '#d4364f');
                    root.style.setProperty('--accent-color', '#1e6b35');
                    break;
                case 'halloween':
                    root.style.setProperty('--primary-color', '#ff6d00');
                    root.style.setProperty('--secondary-color', '#ff9e40');
                    root.style.setProperty('--accent-color', '#311b92');
                    break;
                case 'spring':
                    root.style.setProperty('--primary-color', '#4caf50');
                    root.style.setProperty('--secondary-color', '#81c784');
                    root.style.setProperty('--accent-color', '#8bc34a');
                    break;
                default: // Default theme
                    root.style.setProperty('--primary-color', '#4a6fa5');
                    root.style.setProperty('--secondary-color', '#6b8cbc');
                    root.style.setProperty('--accent-color', '#ff9a3c');
                    break;
            }
            
            // Save theme preference
            state.theme = theme;
            saveToLocalStorage();
        }

        // Toggle dark mode
        function toggleDarkMode() {
            const body = document.body;
            state.darkMode = !state.darkMode;
            
            if (state.darkMode) {
                body.classList.add('dark-theme');
                elements.darkModeToggle.textContent = 'â˜€ï¸';
            } else {
                body.classList.remove('dark-theme');
                elements.darkModeToggle.textContent = 'ðŸŒ™';
            }
            
            // Save preference
            saveToLocalStorage();
        }

        // Import/Export functions
        function exportAllData() {
            const dataStr = JSON.stringify(state);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'classroom-bingo-data.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        function importAllData(event) {
            const file = event.target.files[0];
            
            if (!file) {
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (!importedData.wordLists || !importedData.classes || !importedData.currentGame) {
                        throw new Error('Invalid data format');
                    }
                    
                    // Update state
                    state = importedData;
                    
                    // Save to localStorage
                    saveToLocalStorage();
                    
                    // Update UI
                    renderWordLists();
                    renderClasses();
                    updateDropdowns();
                    renderBingoCards();
                    renderCalledWords();
                    renderPlayersList();
                    
                    // Apply theme
                    setTheme(state.theme || 'default');
                    
                    // Apply dark mode
                    if (state.darkMode) {
                        document.body.classList.add('dark-theme');
                        elements.darkModeToggle.textContent = 'â˜€ï¸';
                    } else {
                        document.body.classList.remove('dark-theme');
                        elements.darkModeToggle.textContent = 'ðŸŒ™';
                    }
                    
                    alert('Data imported successfully!');
                } catch (error) {
                    alert('Error importing data: ' + error.message);
                }
            };
            
            reader.readAsText(file);
        }

        // Local Storage functions
        function saveToLocalStorage() {
            localStorage.setItem('classroomBingoState', JSON.stringify(state));
        }

        function loadFromLocalStorage() {
            const savedState = localStorage.getItem('classroomBingoState');
            
            if (savedState) {
                try {
                    state = JSON.parse(savedState);
                    
                    // Initialize missing properties if needed
                    if (!state.currentGame.notes) {
                        state.currentGame.notes = {};
                    }
                } catch (error) {
                    console.error('Error loading saved state:', error);
                }
            }
        }

        // Utility functions
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Initialize the application
        init();
    </script>
</body>
</html>